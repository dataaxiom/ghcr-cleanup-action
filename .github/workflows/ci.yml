name: Integration Tests

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

jobs:
  setup:
    name: Setup
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .node-version
          cache: npm

      - name: Install Dependencies
        run: npm ci

      - name: Check Format
        run: npm run format:check

      - name: Lint
        run: npm run lint

      - name: Test
        run: npm run ci-test

      - name: Build Tester
        run: npm run ci-tester

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest

    strategy:
      matrix:
        tests:
          - title: "Single-1: Untagged"
            purpose: "Removes all untagged images (single arch)"
            folder: "single-untagged"

          - title: "Multi-1: Untagged"
            purpose: "Removes all untagged images (multi arch)"
            folder: "multi-untagged"

          - title: "Single-2: Tagged"
            purpose: "Removes images with specific tag (single arch)"
            folder: "single-tagged"
            tags: "uclibc-1.35,uclibc-1.36"

          - title: "Multi-2: Tagged"
            purpose: "Removes images with specific tag (multi arch)"
            folder: "multi-tagged"
            tags: "uclibc-1.35,uclibc-1.36"

          - title: "Single-3: Keep N Tagged"
            purpose: "Removes all but the newest 2 tagged images (single arch)"
            folder: "single-keep-n-tagged"
            keep-n-tagged: 2
            exclude-tags: dummy

          - title: "Multi-3: Keep N Tagged"
            purpose: "Removes all but the newest 2 tagged images (multi arch)"
            folder: "multi-keep-n-tagged"
            keep-n-tagged: 2
            exclude-tags: dummy

          - title: "Single-4: Keep N Untagged"
            purpose: "Removes all but the newest 2 untagged images (single arch)"
            folder: "single-keep-n-untagged"
            keep-n-untagged: 2

          # - title: "Multi-4: Keep N Untagged"
          #   purpose: "Removes all but the newest 2 untagged images (multi arch)"
          #   folder: "multi-keep-n-untagged"
          #   keep-n-untagged: 2


    steps:
      - name: "Starting Test: ${{ matrix.tests.title }}"
        description: "Purpose: ${{ matrix.tests.purpose }}"
        run: | 
          if [ -z "${{ matrix.tests.tags }}" ]; then
            export TAGS=""
          else
            export TAGS="--tags ${matrix.tests.tags}"
          fi
          if [ -z "${{ matrix.tests.keep-n-tagged }}" ]; then
            export KEEP_N_TAGGED=""
          else
            export KEEP_N_TAGGED="--keep-n-tagged ${matrix.tests.keep-n-tagged}"
          fi
          if [ -z "${{ matrix.tests.keep-n-untagged }}" ]; then
            export KEEP_N_UNTAGGED=""
          else
            export KEEP_N_UNTAGGED="--keep-n-untagged ${matrix.tests.keep-n-untagged}"
          fi
          if [ -z "${{ matrix.tests.exclude-tags }}" ]; then
            export EXCLUDE_TAGS=""
          else
            export EXCLUDE_TAGS="--exclude-tags ${matrix.tests.exclude-tags}"
          fi

      - name: " > Priming Test Environment"
        run: |
          node citester/index.js --token ${{ secrets.GITHUB_TOKEN }} \
            --directory tests/${{ matrix.tests.folder }} \
            --mode prime

      - name: " > Running Workflow"
        uses: ./
        with:
          tags: ${{ env.TAGS }}
          keep_n_tagged: ${{ env.KEEP_N_TAGGED }}
          keep_n_untagged: ${{ env.KEEP_N_UNTAGGED }}
          exclude_tags: ${{ env.EXCLUDE_TAGS }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: " > Validating Outcome"
        run: |
          node citester/index.js --token ${{ secrets.GITHUB_TOKEN }} \
            --directory tests/${{ matrix.tests.folder }} \
            --mode validate
